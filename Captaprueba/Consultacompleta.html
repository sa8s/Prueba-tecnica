<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Consultas Requeridas — Reportes (Opción 1)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#f7f8fb}
  label,button,select,input{margin:6px 4px;padding:6px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid #e6e6e6;text-align:left;font-size:13px}
  th{background:#f0f2f5}
  .metrics{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .metric{padding:8px;border:1px solid #eee;background:#fff;min-width:180px}
  pre{background:#fff;padding:8px;border:1px solid #eee;max-height:200px;overflow:auto}
</style>
</head>
<body>
  <h2>Consultas Requeridas — (Opción 1: tickets con actividad en el rango)</h2>

  <div>
    <label>Desde: <input type="date" id="desde"></label>
    <label>Hasta: <input type="date" id="hasta"></label>

    <label>Clasificador:
      <select id="classifierSelect">
        <option value="">-- Todos --</option>
      </select>
    </label>

    <label>Estado final a usar:
      <select id="finalSel">
        <option value="actual">Estado actual</option>
        <option value="rango" selected>Estado final dentro del rango</option>
        <option value="ambos">Ambos</option>
      </select>
    </label>

    <button id="runBtn">Generar consultas</button>
    <button id="clearBtn">Limpiar</button>
  </div>

  <div style="margin-top:8px">Estado: <span id="status">esperando</span></div>

  <h3>Métricas</h3>
  <div class="metrics" id="metrics"></div>

  <h3>1) Lista de casos (tickets con actividad en el rango)</h3>
  <div>Casos encontrados: <span id="casesCount">0</span></div>
  <table id="casesTable">
    <thead>
      <tr><th>Tid</th><th>Nombre</th><th>Creado</th><th>Estado Inicial</th><th>Estado Final</th><th>Path completo</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>2) Acciones en el rango (referencia)</h3>
  <div>Acciones en rango: <span id="actionsCount">0</span></div>
  <table id="actionsTable">
    <thead><tr><th>Aid</th><th>TicketId</th><th>Tipo</th><th>From</th><th>To</th><th>Fecha</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>Logs / debug</h3>
  <pre id="log"></pre>

<script>
const API = "http://localhost:3000";
const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const classifierSelect = document.getElementById("classifierSelect");

function log(msg){ console.log(msg); logEl.textContent += msg + "\n"; }
function setStatus(s){ statusEl.textContent = s; }

// parse dates
function parseDate(v){
  if (!v) return null;
  if (v instanceof Date) return v;
  if (typeof v === "string") return new Date(v);
  if (v.$date) return new Date(v.$date);
  if (v["$date"]) return new Date(v["$date"]);
  return new Date(v);
}

// load classificadores
async function loadClasificadores(){
  try{
    const res = await fetch(`${API}/Clasificadores`);
    if (!res.ok) return;
    const list = await res.json();

    const map = new Map(list.map(n=>[n.Cid, {...n, children:[]}]));    
    for(const n of map.values()){
      if (n.Padre && map.has(n.Padre)) map.get(n.Padre).children.push(n);
    }

    const roots = [];
    for(const n of map.values())
      if (!n.Padre || !map.has(n.Padre)) roots.push(n);

    classifierSelect.innerHTML = `<option value="">-- Todos --</option>`;
    function dfs(node, depth){
      const opt = document.createElement("option");
      opt.value = node.Cid;
      opt.textContent = `${"-".repeat(depth)} ${node.Clasificador} (${node.Cid})`;
      classifierSelect.appendChild(opt);
      for(const ch of node.children) dfs(ch, depth+1);
    }
    roots.forEach(r => dfs(r,0));

  }catch(e){ log("Error cargando clasificadores: " + e.message); }
}

async function fetchReporte(params){
  const qs = new URLSearchParams(params).toString();
  const r = await fetch(`${API}/Reporte?${qs}`);
  if (r.status===404) return [];
  if (!r.ok) throw new Error("Error /Reporte");
  return await r.json();
}

async function fetchAcciones(params){
  const qs = new URLSearchParams(params).toString();
  const r = await fetch(`${API}/Acciones?${qs}`);
  if (r.status===404) return [];
  if (!r.ok) throw new Error("Error /Acciones");
  return await r.json();
}

async function fetchAllTickets(){
  let all=[], p=0;
  while(true){
    const r = await fetch(`${API}/Tickets?p=${p}`);
    if (!r.ok) break;
    const data = await r.json();
    if (!data.length) break;
    all.push(...data);
    if (data.length<20) break;
    p++; if (p>200) break;
  }
  return all;
}

function isReopen(a){
  if (!a.From || !a.To) return false;
  const f = String(a.From).toLowerCase();
  const t = String(a.To).toLowerCase();
  return (f==="closed"||f==="rejected") && (t==="open"||t==="in_progress"||t==="abierto");
}
function isClose(a){
  if (!a.To) return false;
  const t = String(a.To).toLowerCase();
  return (t==="closed"||t==="rejected");
}

// MAIN
document.getElementById("runBtn").addEventListener("click", async()=>{

  logEl.textContent="";
  setStatus("Procesando...");

  const dVal=document.getElementById("desde").value;
  const hVal=document.getElementById("hasta").value;
  if (!dVal || !hVal){ alert("Selecciona fechas"); return; }

  const desdeIso=new Date(dVal+"T00:00:00Z").toISOString();
  const hastaIso=new Date(hVal+"T23:59:59Z").toISOString();
  const classifier=document.getElementById("classifierSelect").value;
  const finalSel=document.getElementById("finalSel").value;

  try{

    const reporte = await fetchReporte({desde:desdeIso,hasta:hastaIso,final:finalSel});
    const tickets = await fetchAllTickets();
    const ticketMap = new Map(tickets.map(t=>[t.Tid,t]));

    const accionesRango = await fetchAcciones({desde:desdeIso,hasta:hastaIso});
    const accionesHasta = await fetchAcciones({hasta:hastaIso});

    // Tickets con actividad: acciones o creados en rango
    const activeTidSet = new Set();
    for(const a of accionesRango) activeTidSet.add(a.TicketId);
    for(const t of tickets){
      const c=parseDate(t.Creado_en);
      if (c && c>=new Date(desdeIso) && c<=new Date(hastaIso))
        activeTidSet.add(t.Tid);
    }

    // LISTA DE CASOS — filtrado por actividad + include(classifier)
    const listCases = reporte
      .filter(r => activeTidSet.has(r.Tid))
      .map(r=>{
        const t = ticketMap.get(r.Tid)||{};
        const pathArr = Array.isArray(t.Path)?t.Path:(t.Path?[t.Path]:[]);
        return {
          Tid:r.Tid,
          Nombre:r.Nombre,
          Creado_en:t.Creado_en,
          EstadoInicial:r.EstadoInicial,
          EstadoFinal:r.EstadoFinal,
          PathArr:pathArr
        };
      })
      .filter(item=>{
        if (!classifier) return true;
        return item.PathArr.includes(classifier);
      });

    // METRICAS — Todas aplican mismo filtro path.includes(classifier)
    function filteredByPathAndActive(fn){
      return reporte.filter(r=>{
        if (!activeTidSet.has(r.Tid)) return false;
        const t=ticketMap.get(r.Tid)||{};
        const arr=Array.isArray(t.Path)?t.Path:(t.Path?[t.Path]:[]);
        if (classifier && !arr.includes(classifier)) return false;
        return fn(r);
      }).length;
    }

    const abiertosInicio = filteredByPathAndActive(r=>{
      const ei=String(r.EstadoInicial||"").toLowerCase();
      return ei==="open"||ei==="in_progress"||ei==="abierto";
    });

    const closesInRange = filteredByPathAndActive(r=>{
      const ef=String(r.EstadoFinal||"").toLowerCase();
      return ef==="closed"||ef==="rejected";
    });

    const reopensInRange = filteredByPathAndActive(r=>{
      const ei=String(r.EstadoInicial||"").toLowerCase();
      const ef=String(r.EstadoFinal||"").toLowerCase();
      return (ei==="closed"||ei==="rejected") && (ef==="open"||ef==="in_progress"||ef==="abierto");
    });

    // Hasta actual
    const reporteHastaActual = await fetchReporte({hasta:hastaIso,final:"actual"});
    const closesTotal = reporteHastaActual.filter(r=>{
      const t=ticketMap.get(r.Tid)||{};
      const arr = Array.isArray(t.Path)?t.Path:(t.Path?[t.Path]:[]);
      if (classifier && !arr.includes(classifier)) return false;
      const ef=String(r.EstadoFinal||"").toLowerCase();
      return ef==="closed"||ef==="rejected";
    }).length;

    const reopensTotal = accionesHasta.filter(a=>{
      if (!isReopen(a)) return false;
      const t=ticketMap.get(a.TicketId)||{};
      const arr=Array.isArray(t.Path)?t.Path:(t.Path?[t.Path]:[]);
      if (classifier && !arr.includes(classifier)) return false;
      return true;
    }).length;

    const reporteActual = await fetchReporte({final:"actual"});
    const accionesPorTicketHasta = new Map();
    accionesHasta.forEach(a=>{
      if (!accionesPorTicketHasta.has(a.TicketId))
        accionesPorTicketHasta.set(a.TicketId,[]);
      accionesPorTicketHasta.get(a.TicketId).push(a);
    });

    const ticketsReopenNow = reporteActual.filter(r=>{
      const ef=String(r.EstadoFinal||"").toLowerCase();
      if (!(ef==="open"||ef==="in_progress"||ef==="abierto")) return false;

      const t=ticketMap.get(r.Tid)||{};
      const arr=Array.isArray(t.Path)?t.Path:(t.Path?[t.Path]:[]);
      if (classifier && !arr.includes(classifier)) return false;

      const acts=accionesPorTicketHasta.get(r.Tid)||[];
      return acts.some(isReopen);
    }).length;

    const ticketsClosedNow = reporteActual.filter(r=>{
      const ef=String(r.EstadoFinal||"").toLowerCase();
      if (!(ef==="closed"||ef==="rejected")) return false;
      const t=ticketMap.get(r.Tid)||{};
      const arr=Array.isArray(t.Path)?t.Path:(t.Path?[t.Path]:[]);
      if (classifier && !arr.includes(classifier)) return false;
      return true;
    }).length;

    const ticketsOpenAtEnd = listCases.filter(c=>{
      const ef=String(c.EstadoFinal||"").toLowerCase();
      return ef==="open"||ef==="in_progress"||ef==="abierto";
    }).length;

    const formulaLeft = abiertosInicio - closesInRange + reopensInRange;
    const formulaRight = ticketsOpenAtEnd;

    // Render metrics
    const metrics = document.getElementById("metrics");
    metrics.innerHTML = "";
    const addMetric=(t,v)=>{
      const d=document.createElement("div");
      d.className="metric";
      d.innerHTML=`<div style="font-size:12px;color:#666">${t}</div>
                   <div style="font-size:18px;font-weight:bold">${v}</div>`;
      metrics.appendChild(d);
    };

    addMetric("Abiertos al inicio", abiertosInicio);
    addMetric("Cierres (rango)", closesInRange);
    addMetric("Reaperturas (rango)", reopensInRange);
    addMetric("Cierres total hasta fecha", closesTotal);
    addMetric("Reaperturas total hasta fecha", reopensTotal);
    addMetric("Reaperturas actualmente", ticketsReopenNow);
    addMetric("Tickets cerrados hoy", ticketsClosedNow);
    addMetric("Abiertos al final", ticketsOpenAtEnd);
    addMetric("Ecuación", `${formulaLeft} === ${formulaRight}`);

    // Render table listCases
    const tbody=document.querySelector("#casesTable tbody");
    tbody.innerHTML="";
    document.getElementById("casesCount").textContent=listCases.length;

    listCases.forEach(c=>{
      const cr=parseDate(c.Creado_en);
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${c.Tid}</td>
        <td>${c.Nombre||""}</td>
        <td>${cr?cr.toLocaleString():""}</td>
        <td>${c.EstadoInicial||"—"}</td>
        <td>${c.EstadoFinal||"—"}</td>
        <td>${c.PathArr.join(" / ")}</td>`;
      tbody.appendChild(tr);
    });

    const tbodyA=document.querySelector("#actionsTable tbody");
    tbodyA.innerHTML="";
    document.getElementById("actionsCount").textContent=accionesRango.length;

    accionesRango.sort((a,b)=>parseDate(a.Fecha)-parseDate(b.Fecha));
    accionesRango.forEach(a=>{
      const d=parseDate(a.Fecha);
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${a.Aid||""}</td>
        <td>${a.TicketId||""}</td>
        <td>${a.Tipo_de_accion||a.Tipo||""}</td>
        <td>${Array.isArray(a.From)?JSON.stringify(a.From):a.From||""}</td>
        <td>${Array.isArray(a.To)?JSON.stringify(a.To):a.To||""}</td>
        <td>${d?d.toLocaleString():""}</td>`;
      tbodyA.appendChild(tr);
    });

    setStatus("listo");

  }catch(err){
    log(err);
    setStatus("error");
  }

});

// clear
document.getElementById("clearBtn").addEventListener("click", ()=>{
  document.getElementById("desde").value="";
  document.getElementById("hasta").value="";
  document.getElementById("classifierSelect").value="";
  document.getElementById("finalSel").value="rango";
  document.getElementById("metrics").innerHTML="";
  document.querySelector("#casesTable tbody").innerHTML="";
  document.querySelector("#actionsTable tbody").innerHTML="";
  document.getElementById("casesCount").textContent="0";
  document.getElementById("actionsCount").textContent="0";
  logEl.textContent="";
  setStatus("limpio");
});

// init
loadClasificadores();
</script>

</body>
</html>
